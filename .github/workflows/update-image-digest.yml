name: Build image and update manifest digest

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        service_account_key: ${{ secrets.GCP_SA_KEY }}
        project_id: ${{ secrets.GCP_PROJECT }}

    - name: Build & push via Cloud Build
      run: |
        gcloud builds submit --config=cloudbuild.yaml . --project=${{ secrets.GCP_PROJECT }}

    - name: Get pushed image digest
      id: digest
      run: |
        export IMAGE="southamerica-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/offshore-hub-repo/demo-app:latest"
        DIGEST=$(gcloud artifacts docker images describe "$IMAGE" --project=${{ secrets.GCP_PROJECT }} --format='get(image_summary.digest)')
        echo "DIGEST=$DIGEST" >> $GITHUB_ENV

    - name: Update deployment manifest with digest
      run: |
        IMAGE_WITH_DIGEST="southamerica-east1-docker.pkg.dev/${{ secrets.GCP_PROJECT }}/offshore-hub-repo/demo-app@${DIGEST}"
        # replace the image line in the manifest
        sed -E -i "s|southamerica-east1-docker.pkg.dev/[^[:space:]]+|$IMAGE_WITH_DIGEST|g" manifests/deployment.yaml
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config user.name "github-actions[bot]"
        git add manifests/deployment.yaml
        git commit -m "ci: update demo-app image to ${DIGEST}" || echo "no changes to commit"
        git push
